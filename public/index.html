<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>События рядом</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f4f4f4;
      }

      .card {
        background: #fff;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        cursor: pointer;
      }

      .card img {
        max-width: 100%;
        border-radius: 5px;
        margin-bottom: 10px;
      }

      .card h2 {
        margin: 0 0 5px 0;
        font-size: 18px;
      }

      .card p {
        margin: 0;
        font-size: 14px;
        color: #555;
      }

      #detail {
        display: none;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
      }

      #back {
        margin-top: 10px;
        cursor: pointer;
        color: blue;
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <h1>События рядом</h1>
    <div id="list"></div>

    <div id="detail">
      <h2 id="detail-title"></h2>
      <p><strong>Дата:</strong> <span id="detail-date"></span></p>
      <p><strong>Время:</strong> <span id="detail-time"></span></p>
      <p><strong>Место:</strong> <span id="detail-place"></span></p>
      <p>
        <strong>Категория:</strong>
        <span id="detail-category"></span>
        /
        <span id="detail-subcategory"></span>
      </p>
      <p><strong>Тэги:</strong> <span id="detail-tags"></span></p>
      <p><strong>Цена:</strong> <span id="detail-cost"></span></p>
      <p id="detail-desc"></p>
      <img id="detail-img" src="" alt="" />
      <div id="back">Назад к списку</div>
    </div>

    <script>
      const spreadsheetID = '1hIEkmJqEPJ2thixooVviNQL0j1qeLiA00Af8warNT3g';
      const sheetURL = `https://docs.google.com/spreadsheets/d/${spreadsheetID}/gviz/tq?tqx=out:json&gid=0`;

      const listElement = document.getElementById('list');
      const detailElement = document.getElementById('detail');

      function normaliseCell(cell) {
        if (!cell) {
          return '';
        }

        if (cell.f != null) {
          return cell.f;
        }

        if (cell.v == null) {
          return '';
        }

        if (typeof cell.v === 'string') {
          const dateMatch = cell.v.match(/^Date\((\d+),(\d+),(\d+)(?:,(\d+),(\d+),(\d+))?\)$/);

          if (dateMatch) {
            const [year, month, day, hours = 0, minutes = 0] = dateMatch
              .slice(1)
              .map((value) => (value !== undefined ? Number(value) : 0));
            const date = new Date(year, month, day, hours, minutes);

            if (hours !== 0 || minutes !== 0) {
              return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
            }

            return date.toLocaleDateString('ru-RU');
          }
        }

        return cell.v;
      }

      function parseEvents(rawText) {
        const start = rawText.indexOf('{');
        const end = rawText.lastIndexOf('}') + 1;
        const json = JSON.parse(rawText.slice(start, end));
        const columns = json.table.cols.map((column) => column.label || column.id);

        return json.table.rows
          .map(({ c: cells = [] }) => {
            return columns.reduce((event, column, index) => {
              event[column] = normaliseCell(cells[index]);
              return event;
            }, {});
          })
          .filter((event) => event.Name);
      }

      function renderList(events) {
        listElement.innerHTML = '';

        events.forEach((event) => {
          const card = document.createElement('div');
          card.className = 'card';

          const imageMarkup = event.Media
            ? `<img src="${event.Media}" alt="${event.Name}">`
            : '';

          card.innerHTML = `
            ${imageMarkup}
            <h2>${event.Name}</h2>
            <p>${event.Date || ''} ${event.Time || ''} — ${event.Place || ''}</p>
            <p>Категория: ${event.Category || '—'}${event.Subcategory ? ` / ${event.Subcategory}` : ''}</p>
          `;

          card.onclick = () => showDetail(event);
          listElement.appendChild(card);
        });
      }

      function showDetail(event) {
        listElement.style.display = 'none';
        detailElement.style.display = 'block';

        document.getElementById('detail-title').textContent = event.Name || '';
        document.getElementById('detail-date').textContent = event.Date || '';
        document.getElementById('detail-time').textContent = event.Time || '';
        document.getElementById('detail-place').textContent = event.Place || '';
        document.getElementById('detail-category').textContent = event.Category || '';
        document.getElementById('detail-subcategory').textContent = event.Subcategory || '';
        document.getElementById('detail-tags').textContent = event.Tags || '';
        document.getElementById('detail-cost').textContent = event.cost || '';
        document.getElementById('detail-desc').textContent = event.Description || '';
        document.getElementById('detail-img').src = event.Media || '';
        document.getElementById('detail-img').alt = event.Name || '';
      }

      document.getElementById('back').onclick = () => {
        detailElement.style.display = 'none';
        listElement.style.display = 'block';
      };

      async function loadEvents() {
        try {
          const response = await fetch(sheetURL);

          if (!response.ok) {
            throw new Error('Не удалось получить данные: ' + response.statusText);
          }

          const text = await response.text();
          const events = parseEvents(text);
          renderList(events);
        } catch (error) {
          listElement.innerHTML = '<p>Не удалось загрузить события. Попробуйте обновить страницу позже.</p>';
          console.error(error);
        }
      }

      loadEvents();
    </script>
  </body>
</html>
